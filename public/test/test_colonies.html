<html>

<head>
    <meta charset="utf-8">

    <script src="../src/jquery-3.6.0.min.js"></script>
    <script src="../src/crypto/wasm_exec.js"></script>
    <script src="../src/crypto/crypto.js"></script>
    <script src="../src/colonies.js"></script>

</head>

<body>
    <script>
        $(function () {
            let serverPrvKey = "fcc79953d8a751bf41db661592dc34d30004b1a651ffa0725b03ac227641499d"
            let colonies = new Colonies("rocinante", "50080")
            let colonyId = ""
            let colonyPrvKey = ""
            let executorPrvKey = ""
            let processid = ""

            colonies.load()
                .then(() => {
                    console.log("done loading colonies lib")
                    return colonies.getColonies(serverPrvKey)
                }).then((colonies, err) => {
                    console.log("listening all colonies")
                    console.log(colonies)
                }).then(() => {
                    colonyPrvKey = colonies.crypto.prvkey()
                    colonyId = colonies.crypto.id(colonyPrvKey)
                    console.log("register new colony with id " + colonyId)

                    let colony = {
                        "colonyid": colonyId,
                        "name": "test_colony_name"
                    }

                    return colonies.addColony(colony, serverPrvKey)
                }).then((added_colony, err) => {
                    executorPrvKey = colonies.crypto.prvkey()
                    executorId = colonies.crypto.id(executorPrvKey)
                    newExecutor = {
                        "executorid": executorId,
                        "executortype": "test_executor_type",
                        "executorname": "test_executor_name",
                        "colonyid": colonyId,
                        "state": 0
                    }
                    console.log("register new colonies with id " + executorId)

                    return colonies.addExecutor(newExecutor, colonyPrvKey)
                }).then((added_executor, err) => {
                    console.log("approving executor with id " + executorId)
                    return colonies.approveExecutor(newExecutor.executorid, colonyPrvKey)
                }).then((err) => {
                    console.log("subscribing to pending processes")
                    colonies.subscribeProcesses("test_executor_type", 0, executorPrvKey, function (processes) {
                        console.log("got a pending processes notification")
                    })
                    return new Promise((res) => setTimeout(() => res("p1"), 1000));
                }).then((err) => {
                    console.log("submitting process to colony " + colonyId)
                    let spec = {
                        "timeout": -1,
                        "maxretries": 3,
                        "conditions": {
                            "colonyid": colonyId,
                            "executortype": "test_executor_type",
                        },
                        "env": {
                            "test_key_1": "test_value_1"
                        }
                    }

                    return colonies.submit(spec, executorPrvKey)
                }).then((added_process, err) => {
                    processid = added_process.processid
                    console.log("assigning process " + processid + " to executor " + executorId)
                    console.log(colonyId)
                    console.log(executorPrvKey)
                    return colonies.assign(colonyId, 10, executorPrvKey)
                }).then((process, err) => {
                    console.log("xxxxxxxxxxxxxx")
                    console.log(process)
                    console.log("closing process " + process.processid)
                    return colonies.close(process.processid, executorPrvKey)
                })
        });
    </script>
</body>

</html>
